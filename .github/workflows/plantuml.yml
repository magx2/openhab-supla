name: Generate PlantUML images

on:
  push:
    paths:
      - "puml/*.puml"
      - ".github/workflows/plantuml.yml"

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Install PlantUML
        run: |
          sudo apt-get update
          sudo apt-get install -y plantuml graphviz

      - name: Generate PNG diagrams
        run: |
          shopt -s nullglob

          for file in puml/*.puml; do
            if [[ ! -s "$file" ]]; then
              echo "Skipping empty PlantUML file: $file"
              continue
            fi

            if ! grep -q "@start" "$file"; then
              echo "Skipping PlantUML file without diagram markers: $file"
              continue
            fi

            plantuml -tpng -o ../imgs "$file"
          done

      - name: Commit updated diagrams
        if: github.event_name == 'push'
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'

          git status -uno

          if [[ `git status --porcelain` ]]; then
            git add imgs/*.png
            git status -uno
            git commit -m "Generate PlantUML diagrams"
            git push
          else
            echo "üëç Diagrams are up to date"
          fi
